---
jupyter:
  jupytext:
    formats: ipynb,md
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.16.1
  kernelspec:
    display_name: pa-aa-ner-flooding
    language: python
    name: pa-aa-ner-flooding
---

# Vulnerability mapping

```python
%load_ext jupyter_black
%load_ext autoreload
%autoreload 2
```

```python
import geopandas as gpd
import pandas as pd
import matplotlib.pyplot as plt

from src.datasources import ocha, codab, hydrosheds
from src.constants import ADM3_AOI_PCODES
```

```python
adm3 = codab.load_codab(admin_level=3, aoi_only=True)
adm1 = codab.load_codab(admin_level=1, aoi_only=True)
```

```python
river = hydrosheds.load_niger_river()
river_aoi = gpd.sjoin(river, adm3, how="inner", predicate="intersects")
```

```python
river_aoi.plot()
```

```python
adm3[adm3["ADM3_FR"].str.startswith("Ay")]
```

```python
filepath = ocha.COMMUNES_RAW_PATH.parent / "Book1_fromDaniel.xlsx"
df = pd.read_excel(filepath, skiprows=[0])
df = df.iloc[:-1]
df["Commune"] = df["Commune"].replace("Ayorou", "Ayerou")
df = df.merge(
    adm3.rename(columns={"ADM3_FR": "Commune"})[["Commune", "ADM3_PCODE"]]
)
int_cols = ["Vulnérables"]
df[int_cols] = df[int_cols].astype(int)
df
```

```python
gdf_plot = adm3.merge(df)

fig, ax = plt.subplots(dpi=300)
river_aoi.plot(ax=ax, color="dodgerblue", linewidth=1)
adm1.boundary.plot(ax=ax, linewidth=0.5, color="k")
gdf_plot.plot(ax=ax, color="crimson", alpha=0.3)
gdf_plot.boundary.plot(ax=ax, linewidth=0.2, color="k")

for idx, row in gdf_plot.iterrows():
    plt.annotate(
        text=row["Commune"],
        xy=(row["geometry"].centroid.x, row["geometry"].centroid.y),
        horizontalalignment="center",
        verticalalignment="center",
        fontsize=4,
    )
ax.axis("off")
```

```python
gdf_plot = adm3.merge(df)

plot_col = "Vulnérables"

fig, ax = plt.subplots(dpi=300)
river_aoi.plot(ax=ax, color="dodgerblue", linewidth=1)
adm1.boundary.plot(ax=ax, linewidth=0.5, color="k")
gdf_plot.plot(
    ax=ax,
    column=plot_col,
    cmap="Reds",
    alpha=0.5,
    legend=True,
    legend_kwds={
        "label": plot_col,
        "shrink": 0.6,
    },
)
gdf_plot.boundary.plot(ax=ax, linewidth=0.2, color="k")

for idx, row in gdf_plot.iterrows():
    plt.annotate(
        text=row["Commune"],
        xy=(row["geometry"].centroid.x, row["geometry"].centroid.y),
        horizontalalignment="center",
        verticalalignment="center",
        fontsize=4,
    )
ax.axis("off")
```

```python
gdf_plot
```

```python
gdf_plot = adm3[adm3["ADM3_PCODE"].isin(ADM3_AOI_PCODES)]

fig, ax = plt.subplots(dpi=300)
river_aoi.plot(ax=ax, color="dodgerblue", linewidth=1)
adm1.boundary.plot(ax=ax, linewidth=0.5, color="grey")
gdf_plot.plot(
    ax=ax, facecolor="crimson", edgecolor="black", linewidth=0.5, alpha=0.5
)

for idx, row in gdf_plot.iterrows():
    plt.annotate(
        text=row["ADM3_FR"],
        xy=(row["geometry"].centroid.x, row["geometry"].centroid.y),
        horizontalalignment="center",
        verticalalignment="center",
        fontsize=4,
    )

ax.axis("off")
```
